<?xml version="1.0" encoding="UTF-8" ?>
<XMLDB PATH="mod/charon/db" VERSION="20150505" COMMENT="XMLDB file for Moodle mod/charon"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="../../../lib/xmldb/xmldb.xsd"
>
    <TABLES>

        <!-- Base tables -->

        <TABLE NAME="charon" COMMENT="Charon instance main table.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="course" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="category_id" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="false"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" LENGTH="255" NOTNULL="true"/>
                <FIELD NAME="description" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
                <FIELD NAME="project_folder" SEQUENCE="false" TYPE="char" LENGTH="255" NOTNULL="true"/>
                <FIELD NAME="extra" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
                <FIELD NAME="created_at" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
                <FIELD NAME="updated_at" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>

                <FIELD NAME="tester_type_code" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="grading_method_code" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>

                <!-- Moodle requires these tables. -->
                <FIELD NAME="intro" SEQUENCE="false" TYPE="char" LENGTH="255" NOTNULL="true" DEFAULT=""/>
                <FIELD NAME="introformat" SEQUENCE="false" TYPE="char" LENGTH="255" NOTNULL="false" DEFAULT=""/>
                <FIELD NAME="timemodified" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="FK_charon_course" TYPE="foreign" FIELDS="course"
                     REFTABLE="course" REFFIELDS="id"/>
                <KEY NAME="FK_charon_grade_categories" TYPE="foreign" FIELDS="category_id"
                     REFTABLE="grade_categories" REFFIELDS="id"/>
                <KEY NAME="FK_charon_grading_method" TYPE="foreign" FIELDS="grading_method_code"
                     REFTABLE="charon_grading_method" REFFIELDS="code"/>
                <KEY NAME="FK_charon_tester_type" TYPE="foreign" FIELDS="tester_type_code"
                     REFTABLE="charon_tester_type" REFFIELDS="code"/>
                <KEY NAME="PK_charon" TYPE="primary" FIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_charon_course" UNIQUE="false" FIELDS="course"/>
                <INDEX NAME="IXFK_charon_tester_type" UNIQUE="false" FIELDS="tester_type_code"/>
                <INDEX NAME="IXFX_charon_grading_method" UNIQUE="false" FIELDS="grading_method_code"/>
                <INDEX NAME="IXFX_charon_grade_categories" UNIQUE="false" FIELDS="category_id"/>
            </INDEXES>
        </TABLE>

        <TABLE NAME="charon_grademap" COMMENT="Grades for Charon.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="charon_id" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" LENGTH="255" NOTNULL="true"/>
                <FIELD NAME="grade_type_code" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="grade_item_id" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="false"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_charon_grademap" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_grademap_charon" TYPE="foreign" FIELDS="charon_id"
                     REFTABLE="charon" REFFIELDS="id"/>
                <KEY NAME="FK_grademap_grade_item" TYPE="foreign" FIELDS="grade_item_id"
                     REFTABLE="grade_items" REFFIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_grademap_charon" UNIQUE="false" FIELDS="charon_id"/>
                <INDEX NAME="IXFK_grademap_grade_item" UNIQUE="false" FIELDS="grade_item_id"/>
            </INDEXES>
        </TABLE>

        <TABLE NAME="charon_deadline" COMMENT="Deadline for the grade.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="charon_id" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="deadline_time" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
                <FIELD NAME="percentage" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="true"/>
                <FIELD NAME="group_id" SEQUENCE="false" TYPE="int" LENGTH="10" NOTNULL="false"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_charon_deadline" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_deadline_charon" TYPE="foreign" FIELDS="charon_id"
                     REFTABLE="charon" REFFIELDS="id"/>
                <KEY NAME="FK_deadline_groups" TYPE="foreign" FIELDS="group_id"
                     REFTABLE="groups" REFFIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_deadline_charon" UNIQUE="false" FIELDS="charon_id"/>
                <INDEX NAME="IXFK_deadline_groups" UNIQUE="false" FIELDS="group_id"/>
            </INDEXES>
        </TABLE>

        <TABLE NAME="charon_teacher_comment"
               COMMENT="Teacher comment on the Charon instance for student.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="charon_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="student_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="teacher_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="message" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
                <FIELD NAME="created_at" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_charon_teacher_comment" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_teacher_comment_charon" TYPE="foreign" FIELDS="charon_id"
                     REFTABLE="charon" REFFIELDS="id"/>
                <KEY NAME="FK_teacher_comment_user" TYPE="foreign" FIELDS="student_id"
                     REFTABLE="user" REFFIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_teacher_comment_charon" UNIQUE="false" FIELDS="charon_id"/>
                <INDEX NAME="IXFK_teacher_comment_user" UNIQUE="false" FIELDS="student_id"/>
            </INDEXES>
        </TABLE>


        <!-- Submissions -->

        <TABLE NAME="charon_submission"
               COMMENT="Submission.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="charon_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="user_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="git_hash" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="255"/>
                <FIELD NAME="confirmed" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="1" DEFAULT="0"/>
                <FIELD NAME="git_timestamp" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
                <FIELD NAME="git_commit_message" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
                <FIELD NAME="created_at" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
                <FIELD NAME="updated_at" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
                <FIELD NAME="mail" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
                <FIELD NAME="stdout" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
                <FIELD NAME="stderr" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
                <FIELD NAME="git_callback_id" SEQUENCE="false" TYPE="int" NOTNULL="false" LENGTH="10"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_charon_submission" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_submission_charon" TYPE="foreign" FIELDS="charon_id"
                     REFTABLE="charon" REFFIELDS="id"/>
                <KEY NAME="FK_submission_user" TYPE="foreign" FIELDS="user_id"
                     REFTABLE="user" REFFIELDS="id"/>
                <KEY NAME="FK_submission_git_callback" TYPE="foreign" FIELDS="git_callback_id"
                     REFTABLE="charon_git_callback" REFFIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_submission_charon" UNIQUE="false" FIELDS="charon_id"/>
                <INDEX NAME="IXFK_submission_user" UNIQUE="false" FIELDS="user_id"/>
                <INDEX NAME="IXFK_submission_git_callback" UNIQUE="false" FIELDS="git_callback_id"/>
            </INDEXES>
        </TABLE>

        <TABLE NAME="charon_result"
               COMMENT="Result of one grademap.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="submission_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="grade_type_code" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="percentage" SEQUENCE="false" TYPE="number" NOTNULL="true" LENGTH="3" DECIMALS="2"/>
                <FIELD NAME="calculated_result" SEQUENCE="false" TYPE="number" NOTNULL="true" LENGTH="10" DECIMALS="2"/>
                <FIELD NAME="stdout" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
                <FIELD NAME="stderr" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_charon_result" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_result_submission" TYPE="foreign" FIELDS="submission_id"
                     REFTABLE="charon_submission" REFFIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_result_submission" UNIQUE="false" FIELDS="submission_id"/>
            </INDEXES>
        </TABLE>

        <TABLE NAME="charon_submission_file"
               COMMENT="Files included with the submission.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="submission_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="path" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
                <FIELD NAME="contents" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_charon_submission_file" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_submission_file_submission" TYPE="foreign" FIELDS="submission_id"
                     REFTABLE="charon_submission" REFFIELDS="id"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_submission_file_submission" UNIQUE="false" FIELDS="submission_id"/>
            </INDEXES>
        </TABLE>


        <TABLE NAME="charon_git_callback" COMMENT="Git callbacks.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="url" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
                <FIELD NAME="repo" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="255"/>
                <FIELD NAME="user" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="255"/>
                <FIELD NAME="first_response_time" SEQUENCE="false" TYPE="datetime" NOTNULL="false"/>
                <FIELD NAME="secret_token" SEQUENCE="false" TYPE="text" NOTNULL="true"/>
                <FIELD NAME="created_at" SEQUENCE="false" TYPE="datetime" NOTNULL="true"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_git_callback" TYPE="primary" FIELDS="id"/>
            </KEYS>
        </TABLE>


        <!-- Course Settings -->

        <TABLE NAME="charon_course_settings" COMMENT="Course settings.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="course_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="unittests_git" SEQUENCE="false" TYPE="char" NOTNULL="false" LENGTH="255"/>
                <FIELD NAME="tester_type_code" SEQUENCE="false" TYPE="int" NOTNULL="false" LENGTH="10"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_course_settings" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_course_settings_course" TYPE="foreign" FIELDS="course_id"
                     REFTABLE="course" REFFIELDS="id"/>
                <KEY NAME="FK_course_settings_tester_type" TYPE="foreign" FIELDS="tester_type_code"
                     REFTABLE="tester_type" REFFIELDS="code"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_course_settings_course" UNIQUE="false" FIELDS="course_id"/>
                <INDEX NAME="IXFK_course_settings_tester_type" UNIQUE="false" FIELDS="tester_type_code"/>
            </INDEXES>
        </TABLE>


        <!-- Presets -->

        <TABLE NAME="charon_preset"
               COMMENT="Presets for a course.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="255"/>
                <FIELD NAME="parent_category_id" SEQUENCE="false" TYPE="int" NOTNULL="false" LENGTH="10"/>
                <FIELD NAME="course_id" SEQUENCE="false" TYPE="int" NOTNULL="false" LENGTH="10"/>
                <FIELD NAME="calculation_formula" SEQUENCE="false" TYPE="text" NOTNULL="false"/>
                <FIELD NAME="extra" SEQUENCE="false" TYPE="char" NOTNULL="false" LENGTH="255"/>
                <FIELD NAME="grading_method_code" SEQUENCE="false" TYPE="int" NOTNULL="false" LENGTH="10"/>
                <FIELD NAME="max_result" SEQUENCE="false" TYPE="number" NOTNULL="false" LENGTH="10" DECIMALS="2"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_preset" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_preset_grade_categories" TYPE="foreign" FIELDS="parent_category_id"
                     REFTABLE="grade_categories" REFFIELDS="id"/>
                <KEY NAME="FK_preset_course" TYPE="foreign" FIELDS="course_id"
                     REFTABLE="course" REFFIELDS="id"/>
                <KEY NAME="FK_preset_grading_method" TYPE="foreign" FIELDS="grading_method_code"
                     REFTABLE="charon_grading_method" REFFIELDS="code"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_preset_grade_categories" UNIQUE="false" FIELDS="parent_category_id"/>
                <INDEX NAME="IXFK_preset_course" UNIQUE="false" FIELDS="course_id"/>
                <INDEX NAME="IXFK_preset_grading_method" UNIQUE="false" FIELDS="grading_method_code"/>
            </INDEXES>
        </TABLE>
        
        <TABLE NAME="charon_preset_grade" COMMENT="Preset grades.">
            <FIELDS>
                <FIELD NAME="id" SEQUENCE="true" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="preset_id" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="grade_name_prefix_code" SEQUENCE="false" TYPE="int" NOTNULL="false" LENGTH="10"/>
                <FIELD NAME="grade_type_code" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="grade_name" SEQUENCE="false" TYPE="char" NOTNULL="false" LENGTH="255"/>
                <FIELD NAME="max_result" SEQUENCE="false" TYPE="number" NOTNULL="false" LENGTH="10" DECIMALS="2"/>
                <FIELD NAME="id_number_postfix" SEQUENCE="false" TYPE="char" NOTNULL="false" LENGTH="255"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_preset_grade" TYPE="primary" FIELDS="id"/>
                <KEY NAME="FK_preset_grade_preset" TYPE="foreign" FIELDS="preset_id"
                     REFTABLE="charon_preset" REFFIELDS="id"/>
                <KEY NAME="FK_preset_grade_grade_name_prefix" TYPE="foreign" FIELDS="grade_name_prefix_code"
                     REFTABLE="charon_grade_name_prefix" REFFIELDS="code"/>
            </KEYS>
            <INDEXES>
                <INDEX NAME="IXFK_preset_grade_preset" UNIQUE="false" FIELDS="preset_id"/>
                <INDEX NAME="IXFK_preset_grade_grade_name_prefix" UNIQUE="false" FIELDS="grade_name_prefix_code"/>
            </INDEXES>
        </TABLE>


        <!-- Classifications -->

        <TABLE NAME="charon_tester_type"
               COMMENT="Tester types. Every language has its own type. Ie. Java, Python.">
            <FIELDS>
                <FIELD NAME="code" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="50"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_tester_type" TYPE="primary" FIELDS="code"/>
            </KEYS>
        </TABLE>

        <TABLE NAME="charon_grade_type"
               COMMENT="Grade type. Ie. tests, style, defense.">
            <FIELDS>
                <FIELD NAME="code" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="50"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_grade_type" TYPE="primary" FIELDS="code"/>
            </KEYS>
        </TABLE>

        <TABLE NAME="charon_grading_method"
               COMMENT="Grading method codes ie. prefer_best / prefer_last depends on instance configuration">
            <FIELDS>
                <FIELD NAME="code" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="50"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_grading_method" TYPE="primary" FIELDS="code"/>
            </KEYS>
        </TABLE>

        <TABLE NAME="charon_grade_name_prefix"
               COMMENT="Grade name prefix for presets. Can be the project folder for example. The NAME should be preset_grade_name_prefix but that is too long! Maybe think of a better table name.">
            <FIELDS>
                <FIELD NAME="code" SEQUENCE="false" TYPE="int" NOTNULL="true" LENGTH="10"/>
                <FIELD NAME="name" SEQUENCE="false" TYPE="char" NOTNULL="true" LENGTH="255"/>
            </FIELDS>
            <KEYS>
                <KEY NAME="PK_grade_name_prefix" TYPE="primary" FIELDS="code"/>
            </KEYS>
        </TABLE>

    </TABLES>
</XMLDB>
